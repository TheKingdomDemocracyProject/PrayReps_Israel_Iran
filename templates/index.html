{% extends "base.html" %}

{% block title %}PrayReps - Home{% endblock %}

{% block page_title %}Praying for {{ current_country_name if current else "Representatives" }}{% endblock %}

{% block head_extra %}
    {# Any page-specific head elements, like specific JS variables if not handled by context processors #}
    <script>
        // Provide defaults for tojson filter to prevent errors if vars are None or Undefined.
        let initialMapCountryCode = {{ initial_map_country_code | default(None) | tojson | safe }};

        {# These lines were suspected to cause issues if all_countries_config or party_info_all_countries were Undefined.
           They are currently JS-commented out. If they were to be used, they'd also need defaults.
        // const ALL_COUNTRIES_CONFIG_JS = {{ all_countries_config | default({}) | tojson | safe }};
        // const PARTY_INFO_ALL_COUNTRIES_JS = {{ party_info_all_countries | default({}) | tojson | safe }};
        #}
    </script>
{% endblock %}

{% block content %}
    <div class="intro-text">
        <p>Welcome to PrayReps! We're glad you're here to pray for the elected representatives of <strong>Israel</strong> and <strong>Iran</strong>.</p>
        <p>Below, you'll see one representative at a time. Take a moment to pray for them, then click "üôè Amen" to move to the next person. The map will update to show who you've prayed for. For more information, check out the <a href="{{ url_for('main.about_page') }}">About page</a>.</p>
    </div>

    {# This div will be updated by HTMX after processing an item via OOB swap #}
    {# These containers will be updated by HTMX after processing an item via OOB swap from prayer.process_item_htmx #}
    <div id="stats-summary-container" hx-swap-oob="true">
        {% include 'partials/_stats_summary.html' with context %}
    </div>

    <div class="content">
        <div class="left-content">
            {# This div is the primary target for the Amen button's HTMX POST.
               It will be replaced by the response from process_item_htmx,
               which should include this container itself with updated content
               and the other OOB swap divs.
            #}
            <div id="main-interaction-content">
                {# The _current_item_display.html partial now includes the Amen button #}
                {# This ensures the button's hx-vals are always fresh for the current item #}
                <div id="current-item-container" hx-swap-oob="true">
                    {% include 'partials/_current_item_display.html' with context %}
                </div>
            </div>
             {# No separate controls div here anymore, it's inside _current_item_display.html #}
        </div>
        <div class="right-content">
            <div id="map-image-container" hx-swap-oob="true">
                {% include 'partials/_map_image_display.html' with context %}
            </div>
        </div>
    </div>

    {# Removed old queue list and script, will be handled by HTMX or separate pages #}
    {# The links are now in the main navigation in base.html #}

{% endblock %}

{% block scripts_extra %}
<script>
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // This event fires after HTMX has swapped content.
        // We can use this to re-evaluate things or trigger further actions if needed.
        // For example, if a specific part of the page needs re-initialization for some JS library.
        console.log('HTMX content swapped. Target:', event.detail.target.id);

        // If the current item container was swapped and it's now empty (no more items)
        // we might need to disable the Amen button.
        const amenButton = document.getElementById('amen-button');
        if (amenButton) {
            const currentItemContent = document.getElementById('current-item-container').textContent || "";
            if (currentItemContent.includes("Queue is empty") || currentItemContent.includes("All prayers complete")) {
                amenButton.disabled = true;
            } else {
                // Check if the new content for current-item-container has a valid new item ID for the button
                // This is tricky because the button itself is part of the swapped content if hx-target is its parent.
                // The hx-vals on the button should ideally be updated by the server response if it's swapping the button too.
                // If only _current_item_display.html is swapped, the button's hx-vals needs dynamic update.
                // The current HTMX setup replaces the #current-item-container, which includes the button if it's inside the partial.
                // The partial _current_item_display.html should handle disabling the button or setting correct hx-vals.
            }
        }
    });

    // Example of how to handle HX-Triggered events if we used them more extensively
    /*
    document.body.addEventListener('updateMap', function(event) {
        const newMapSrc = event.detail.newSrc;
        const mapImage = document.getElementById('hexmap-image'); // Ensure your map image has this ID
        if (mapImage && newMapSrc) {
            mapImage.src = newMapSrc;
            console.log('Map image updated via HX-Trigger:', newMapSrc);
        }
    });

    document.body.addEventListener('updateStats', function(event) {
        // Assuming the stats summary is fetched and swapped by an HTMX element itself
        // Or, if event.detail contains HTML for stats:
        // const statsContainer = document.getElementById(event.detail.target);
        // if (statsContainer && event.detail.html) {
        //    statsContainer.innerHTML = event.detail.html;
        // }
        console.log('Stats update triggered.');
        // Example: htmx.trigger("#stats-summary-container", "loadStats");
        // and <div id="stats-summary-container" hx-get="/path/to/stats/fragment" hx-trigger="loadStats">
    });
    */
</script>
{% endblock %}
